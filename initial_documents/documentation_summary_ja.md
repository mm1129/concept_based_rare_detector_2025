# 概念ベース希少物体検出システム - 概要ドキュメント

## 本プロジェクトの概要

本プロジェクトは、自動運転車や監視カメラなどの画像データから、一般的でない「希少物体」や「異常物体」を自動検出するシステムです。特に以下の特徴を持ちます：

1. **2段階の物体認識アプローチ**による高精度検出
2. **マルチモーダルAI**（CLIP、Qwen2-VL）を活用した意味理解
3. **特徴空間と意味空間の両方**で異常を検出する多層的アプローチ
4. **メモリ効率と処理速度**を最適化した実装

## ドキュメント構成

本システムに関する詳細は、以下の3つのドキュメントに分かれています：

1. [**実装ドキュメント**](./documentation_ja.md) - システムアーキテクチャと実装の詳細
2. [**モデル詳細ドキュメント**](./documentation_models_ja.md) - 使用されている深層学習モデルの詳細
3. [**使用方法ガイド**](./documentation_usage_ja.md) - システムの使用方法とワークフロー

## 主要なコンポーネントと技術

### 1. 物体検出と特徴抽出

- **YOLOv8**による物体検出と切り抜き
- **CLIP**による画像特徴の抽出（512次元埋め込み）
- 効率的なバッチ処理と動的メモリ管理

### 2. 異常検知技術

- **Isolation Forest**による特徴空間での異常検知
- **t-SNE**による高次元特徴の可視化
- **概念ベースの意味的異常検知**（CLIPとQwen2-VLの統合）

### 3. 視覚言語理解

- **Qwen2-VL**による画像キャプション生成
- コンテキスト特化型プロンプト設計
- 概念マッチングによる意味理解

## システムのワークフロー

1. **初期化と物体検出**：画像からYOLOv8で物体を検出し切り抜き
2. **特徴抽出**：CLIPで切り抜き画像から特徴ベクトルを抽出
3. **特徴ベースの異常検知**：Isolation Forestで異常を検出
4. **キャプション生成**：Qwen2-VLで検出物体の説明を生成
5. **意味ベースの異常検知**：生成されたキャプションと概念リストの類似度を分析
6. **結果統合**：特徴ベースと意味ベースの異常判定を統合
7. **出力**：異常物体の抽出、可視化、詳細分析結果の保存

## 主な利用シナリオ

1. **自動運転の安全性向上**：道路上の珍しい物体や危険物の検出
2. **監視セキュリティ**：通常とは異なる状況や物体の検出
3. **品質管理**：製造ラインにおける異常製品の検出
4. **データセットキュレーション**：大規模画像データからの特異サンプルの発見

## 技術的特徴と工夫点

1. **マルチモーダル統合**：
   - 物体検出、特徴抽出、テキスト生成の相互補完的活用
   - 視覚特徴と意味理解の統合による高精度化

2. **計算効率の最適化**：
   - 動的バッチサイズ調整によるGPUメモリの最適利用
   - サブバッチ処理による大規模データセット対応
   - 混合精度計算による処理速度向上

3. **ロバスト性向上**：
   - エラー処理と例外対応の強化
   - 破損データや処理失敗への対策
   - 処理状況の詳細な可視化と記録

## 使用開始方法

```bash
# 基本的な異常検出の実行
python detect_outliers_single_folder.py \
  --images_folder ./your_images \
  --output_dir ./results \
  --qwen_model_size 2B
```

詳細な使用方法は[使用方法ガイド](./documentation_usage_ja.md)を参照してください。

## 拡張と将来の発展

- **ドメイン適応**：特定環境向けの微調整と最適化
- **時間的文脈の活用**：ビデオストリームでの時系列分析
- **説明可能性の向上**：検出結果の根拠提示機能の強化
- **より高精度なモデルの統合**：最新のVLMやセグメンテーションモデルの導入

## 実装上の注意点

- **メモリ要件**：最小8GB GPU RAM（Qwen2-VL-2B使用時）
- **処理時間**：1,000枚の画像処理に約2-4時間（GPU環境）
- **依存ライブラリ**：PyTorch 2.0以上、Transformers 4.30以上、Ultralytics

詳細な情報は各ドキュメントを参照してください。

## 実装ファイルとドキュメントの対応関係

本システムには2つの主要な実装ファイルがあります：

### 1. `detect_outliers_single_folder.py`

このファイルは単一フォルダ処理モードの実装で、以下の機能を提供します：

- 1つのフォルダ内の全画像に対する一括処理
- 単一実行での完全な異常検出パイプライン
- 独立した分析と結果生成

**対応するドキュメント**:
- [使用方法ガイド](./documentation_usage_ja.md) の「2.1 単一フォルダ処理モード」と「3.1 単一フォルダ処理モードのワークフロー」
- [実装ドキュメント](./documentation_ja.md) の「3.1 単一フォルダ処理モード」

### 2. `whole-architecture_batch.py`

このファイルはベースライン学習モードの実装で、以下の機能を提供します：

- 正常サンプルからのベースラインモデル学習
- 学習モデルを用いた新規画像の異常検出
- 2段階の処理パイプライン（学習と検出）

**対応するドキュメント**:
- [使用方法ガイド](./documentation_usage_ja.md) の「2.2 ベースライン学習モード」と「3.2 ベースライン学習モードのワークフロー」
- [実装ドキュメント](./documentation_ja.md) の「3.2 ベースライン学習と新規画像検出」

### 共通コンポーネント

両実装ファイルは以下の共通コンポーネントを共有しています：

| コンポーネント | 実装 | 主なドキュメント |
|--------------|------|----------------|
| `DetectorYOLO` | 両ファイルに同一実装 | [モデル詳細ドキュメント](./documentation_models_ja.md) の「2.1 YOLOv8：物体検出と抽出」 |
| `CLIPFeatureExtractor` | 両ファイルに同一実装 | [モデル詳細ドキュメント](./documentation_models_ja.md) の「2.2 CLIP：マルチモーダル特徴抽出」 |
| `generate_descriptions_batch` | 類似実装（異なるパラメータ設定） | [モデル詳細ドキュメント](./documentation_models_ja.md) の「2.3 Qwen2-VL：画像キャプション生成」 |
| 異常検知関数 | 共通アルゴリズム、異なる統合方法 | [モデル詳細ドキュメント](./documentation_models_ja.md) の「3. 異常検知技術の実装詳細」 |
| メモリ管理関数 | ほぼ同一の最適化手法 | [実装ドキュメント](./documentation_ja.md) の「4.2 メモリ管理の工夫」 |

## 詳細な実装解説ドキュメント

システムの中核となる2つの実装ファイルについて、詳細な解説を以下の別ドキュメントにまとめています：

1. [**単一フォルダ処理モード実装解説**](./documentation_detect_outliers_single_folder_ja.md) - `detect_outliers_single_folder.py`の詳細な実装解説
2. [**ベースライン学習モード実装解説**](./documentation_whole_architecture_batch_ja.md) - `whole-architecture_batch.py`の詳細な実装解説

これらのドキュメントでは、各実装ファイルの構造、主要機能、コードフロー、最適化手法などを自然言語で詳しく解説しています。コードの深い理解や修正・拡張を行いたい場合は、これらのドキュメントを参照してください。 